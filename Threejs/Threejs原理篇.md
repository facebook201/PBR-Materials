1、threejs 抗锯齿行为

```js
// 默认不开启
new WebGLRenderer({ antialias: true });
```

通过getContext第二个参数，webgl上下文来抗锯齿，采用的是 FXAA算法。典型的边缘检查取样操作。FXAA原理与MSAA相同，其**原理**是通过提取像素界面周围的颜色信息，通过混合颜色信息来消除高对比界面所产生的锯齿





#### Threejs 渲染原理

1、Gemotry + material) = mesh

2、Scene 场景中 有多个物体，然后加上相机  最终会渲染出整个场景。

* 相机，用来表示3D影像是以哪种方式投影的。以透视相机（**PerspectiveCamera**）为例，这一投影模式被用来模拟人眼所看到的景象，它是3D场景的渲染中使用得最普遍的投影模式。

* 场景（Scene）是你放置物体、灯光和摄像机的地方。换句话说，你想要渲染的所有物体，都需要添加在场景中。

* 物体，ThreeJS中提供了 **Geometry** 基类，开发者只要传入参数就可新建一个几何体实例，不需要过于专注 shader program、缓冲区数据绑定等 WebGL 相关的内容。例子中的 **BoxGeometry** 立方几何体就是，只需要传入宽、高、深度就可以构建出一个立方几何体。

* 渲染器，接受场景和相机。将场景中的3D物体、纹理、阴影等以当前相机的投影模式渲染出来。



#### Object3D

相机、场景、物体、Light、Line都继承了 Object3D 这个基类。

- 申明了该对象的id、name、type属性。
  - 唯一id，但是在实际应用中，真的很少用到这个id。
  - name基本没有用到过，作为基类，这个属性暂时想不到它的用处。
  - type标记类型。新创建一个实例，都会为这个属性分配内存；此外开发者可以暴力修改。通过原型来表达类型可能是更合适的。
- 初始化3D相关的数据对象
  - 3D对象的局部位置，通过三维向量表示。表示物体中心点的位置。
  - 缩放信息，通过三维向量表示，表示，x，y，z三个轴方向下的缩放参数。
  - 欧拉角和四元素，表示3D物体旋转的。因为都是表示旋转，所以欧拉角、四元素依赖变换。在构造方法里就做了onChange监听。
  - 对象的全局或世界变换矩阵，即物体相对于世界坐标下的变换矩阵。局部变换矩阵，即相对于父级的变换矩阵，如果没有父级，那么就等同于世界变换矩阵。简单说，通过变换矩阵可以计算得出不同坐标系下的物体的位置。
- 挂载了一些功能标志位，应用在 ThreeJS 渲染流程中。
  - 可见性、是否渲染到阴影贴图、材质是否接受阴影。置为false时，就不会渲染。
  - 是否在相机的视椎体，不在的话也就不会渲染。相机的视椎体，可以简单的理解为在视椎体内部的物体，是相机可以看到的，也就是应该被渲染出来的。
- 提供了树结点的能力。
  - 父指针、孩子数组。

再看基类提供的方法，根据职责主要分为3D数据相关和树结构相关。（因为篇幅所限，就不贴图了。）

- 修改、更新世界矩阵、局部矩阵的方法
- 修改欧拉角、缩放、位移（x、y、z，3个轴方向）的数值的方法
- 渲染前处理、后处理的回调方法



#### 相机

例子里面使用的是 **PerspectiveCamera** 透视相机，继承于**Camera**类。**Camera**类又继承了**Object3D**。所以本质上相机也是一个3D对象。这里就介绍下透视相机的实现。

对于一个相机而言，有以下几个概念（不同相机的计算不完全一致）

- 内参，包括焦距、缩放等相机变量
- 外参，简单说就是旋转矩阵、平移矩阵，用来表示物体从世界坐标系到相机坐标系的转换。
- 投影矩阵，用来表示该相机坐标系下某个点对应到二维平面映射关系。简单公式：投影矩阵*三维点 = 二维平面点。

**PerspectiveCamera** 类 的 **updateProjectionMatrix**方法，根据相机的内参，计算得出透视相机的投影矩阵。这里引用了数学库 **Matrix4** 的 **makePerspective** 方法，该方法表示了透视相机的投影矩阵的数学计算过程。**makePerspective** 方法作为透视相机的静态方法，直接挂在 **PerspectiveCamera** 类上可能会更优雅一些。



#### 场景

**Scene** 类也是继承于**Object3D**基类。在平时开发的过程中，开发者使用的新增物体的能力，其实是 **Object3D** 提供的。**Scene** 类本身只是提供了默认的背景、雾、纹理贴图、覆盖材料的能力。结合后续的渲染器代码的解析，在树根节点的背景、纹理的设置也会影响到孩子节点的背景、纹理的渲染。

![border](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f390f63339c94b29b75eae890ae08623~tplv-k3u1fbpfcp-zoom-in-crop-mark:1512:0:0:0.awebp?)





this.render 渲染流程

![1d6371df90b68ae5b2db277e6e5695a](C:\Users\shiyao\Desktop\可视化\image\1d6371df90b68ae5b2db277e6e5695a.png)![bc23ae3d12c151a3c9b507d72bb8193](C:\Users\shiyao\Desktop\可视化\image\bc23ae3d12c151a3c9b507d72bb8193.png)